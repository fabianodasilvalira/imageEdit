<!DOCTYPE html>
<html>
  <head lang="en">
    <meta charset="UTF-8" />
    <title>
      ImagerJs - Standalone with Image Uploading (with german translation)
    </title>
    <!-- <script src="https://code.jquery.com/jquery-1.10.1.min.js"></script>
  <script src="https://code.jquery.com/jquery-migrate-1.2.1.min.js"></script> -->
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <!-- <link rel="stylesheet" href="path/to/font-awesome/css/font-awesome.min.css"> -->
    <link
      href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css"
      rel="stylesheet"
    />

    <script src="dist/imagerJs.js"></script>
    <link href="dist/imagerJs.css" rel="stylesheet" />

    <!-- Include german translations -->
    <!-- <script src="imagerJs-german.js"></script> -->

    <style>
      .imager-edit-container .toolbar {
        position: absolute;
      }

      #imagers {
        display: flex;
        align-items: flex-start;
        flex-wrap: wrap;
      }

      .imager-test {
        display: inline-block;
        margin-top: 30px;
        margin-bottom: 100px;
      }

      .imager-test.custom-quality-visible {
        margin-bottom: 200px;
      }

      .image-container {
        min-width: 300px;
        margin-right: 30px;
        text-align: left;
      }
    </style>
  </head>
  <body onload="addNew()">
    <div class="container" id="container_img">
      <div class="panel panel-default">
        <div class="panel-body">
          <div class="form-group" id="imagers"></div>
        </div>
      </div>
    </div>

    <!-- Mostrar redação anexada -->
    <form id="redacao_simulado" class="col-md-12 upload20 redacao_simulado" enctype="multipart/form-data">
      <div id="displayRedacao" style="display: none">
        <iframe id="output" style="margin: 10px 0; width: 100%; height: 400px" ></iframe>
        <div class="row">
          <div class="col-md-4"></div>
          <div class="form-group col-md-4">
            <button type="submit" id="salvarPdf" class="btn btn-success">
              Salvar arquivo
            </button>
            <button type="button" class="btn btn-danger" onclick="clearFile()">
              Remover arquivo
            </button>
          </div>
          <div class="col-md-4"></div>
        </div>
      </div>
      <div id="respostas" class="mt-lg-3 text-center"></div>
    </form>
    <!-- Fim mostrar redação anexada -->

    <script>
      // apply german translations
      ImagerJs.translations.set(window.ImagerJsGerman);

      var pluginsConfig = {
        Crop: {
          controlsCss: {
            width: "15px",
            height: "15px",
            background: "#000",
            border: "1px solid black",
          },
          controlsTouchCss: {
            width: "25px",
            height: "25px",
            background: "#000",
            border: "2px solid black",
          },
        },
        Save: {
          upload: true,
          uploadFunction: function (imageId, imageData, callback) {
            var imager = this;
    
            console.log("uploading Save " + imageId);

            // var data = imageData;
            var data = new FormData();
            data.append("file", imageData);
            // var data = imageData.replace(
            //   /^data:image\/(png|jpg|jpeg);base64,/,
            //   ""
            // );
       
            var dataJson = '{ "imageData" : "' + data + '" }';

            $.ajax({
              url: "upload.php",
              processData: false,
              contentType: false,
              data: data,
              type: "POST",
              success: function (imageUrl) {
                // data:image/png;base64,
                // callback(imageUrl); // assuming that server returns an `imageUrl` as a response
                console.log(imageUrl);
              },
              error: function (xhr, status, error) {
                console.log("ERRO: ", error);
              },
            });
          },
        },
      };

      var options = {
        plugins: [
          "Rotate",
          "Crop",
          "Resize",
          "Toolbar",
          "Save",
          "Delete",
          "Undo",
        ],
        editModeCss: {},
        pluginsConfig: pluginsConfig,
        quality: {
          sizes: [
            // { label: "Original", scale: 1, quality: 1, percentage: 100 },
            { label: "Large", scale: 0.5, quality: 0.5, percentage: 50 },
            // { label: "Medium", scale: 0.2, quality: 0.2, percentage: 20 },
            // { label: "Small", scale: 0.05, quality: 0.05, percentage: 5 },
          ],
        },
      };

      var addNew = function () {
        var $imageContainer = $(
          '<div class="image-container">' +
            '  <img class="imager-test" ' +
            '       src="" ' +
            '       style="min-width: 300px; min-height: 200px; width: 300px;">' +
            "</div>"
        );

        $("#imagers").append($imageContainer);
        var imager = new ImagerJs.Imager($imageContainer.find("img"), options);
        imager.startSelector();

        imager.on("editStart", function () {
          // fix image dimensions so that it could be properly placed on the grid
          imager.$imageElement.css({
            minWidth: "auto",
            minHeight: "auto",
          });
          var qualitySelector = new window.ImagerQualitySelector(
            imager,
            options.quality
          );

          var qualityContainer = $(
            '<div class="imager-quality-standalone"></div>'
          );
          qualityContainer.append(qualitySelector.getElement());

          imager.$editContainer.append(qualityContainer);

          qualitySelector.show();
          qualitySelector.update();
        });
      };

      const clearFile = () => {
        $("#container_img").css("display", "block");
        $(".imager-selector-container").css("display", "block");
        document.getElementById("displayRedacao").style.display = "none";
        const redacaoInput = document.getElementById("upl");
        redacaoInput.value = "";

        var output = document.getElementById("output");

        output.src = "";
      };
    </script>
  </body>
</html>
